#!/system/bin/sh

#export PATH=$(magisk --path)/.magisk/busybox:$PATH:/system/bin

settings="/data/adb/box/settings.ini"
# path busybox
busybox_path="/data/adb/magisk/busybox"
# true: enable / false: disable Ipv6
ipv6="false"

box_user_group="0:3005"

# list of available kernel binaries
bin_list=("clash" "sing-box" "xray" "v2fly")

# select the client to use : clash / sing-box / xray / v2fly
bin_name='clash'

# make sure the port is in sync with the config
tproxy_port="9898"
redir_port="9797"

# redirect: tcp / tproxy: udp + tcp / mixed: tcp + tun
network_mode="tproxy"

# Proxy mode: blacklist / whitelist / tun (only tun auto-route)
proxy_mode="blacklist"

# ap_list=("softap+" "wlan+" "swlan+" "ap+" "rndis+")
# for AP info type "ifconfig" in terminal
ap_list=(
  "wlan+"
  "rndis+"
)
# for AP bypass
ignore_out_list=()

# List of package names to be proxied
packages_list=(
  com.v2ray.ang
)

# Set box directory variables
data_dir="/data/adb/box"
run_path="${data_dir}/run"
logs_file="${run_path}/runs.log"
pid_file="${run_path}/box.pid"
bin_kernel="${data_dir}/bin"
bin_path="${bin_kernel}/${bin_name}"
scripts_dir="${data_dir}/scripts"
system_packages_file="/data/system/packages.list"
uid_list=("/data/adb/box/run/appuid.list")

# config clash
name_clash_config="config.yaml"
clash_config="${data_dir}/clash/${name_clash_config}"
# Membaca nilai enable dari konfigurasi tun
clash_tun_status=$(awk -F ': ' '/^tun: *$/{getline; print $2}' "${clash_config}")

log() {
  # Set the timezone to Asia/Jakarta
  export TZ=Asia/Jakarta  
  # Get the current time
  now=$(date +"%I.%M %p %Z")
  case $1 in
    # print the log message in blue
    info) color="\033[1;34m" ;;
    # print the log message in red
    error) color="\033[1;31m" ;;
    # print the log message in yellow
    warn) color="\033[1;33m" ;;
    # print the log message in magenta
    *) color="\033[1;35m" ;;
  esac
  message="${now} [$1]: $2"
  if [ -t 1 ]; then
    echo -e "${color}${message}\033[0m"
  else
    echo "${message}" | tee -a ${logs_file} >> /dev/null 2>&1
  fi
}